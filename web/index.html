<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenClaw Cost Governor</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #0f1419;
      color: #e6edf3;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #30363d;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
    }

    .status-safe { background: #238636; color: white; }
    .status-warning { background: #d29922; color: white; }
    .status-critical { background: #da3633; color: white; }
    .status-exceeded { background: #a40e26; color: white; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 20px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #7d8590;
    }

    .budget-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #21262d;
    }

    .budget-item:last-child {
      border-bottom: none;
    }

    .budget-label {
      font-size: 14px;
    }

    .budget-amount {
      font-size: 18px;
      font-weight: 600;
    }

    .budget-bar {
      height: 8px;
      background: #21262d;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }

    .budget-bar-fill {
      height: 100%;
      transition: width 0.3s ease;
    }

    .fill-safe { background: #238636; }
    .fill-warning { background: #d29922; }
    .fill-critical { background: #da3633; }
    .fill-exceeded { background: #a40e26; }

    .provider-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 14px;
    }

    .provider-name {
      color: #7d8590;
    }

    .provider-cost {
      font-weight: 600;
    }

    button {
      background: #238636;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    button:hover {
      background: #2ea043;
    }

    button.danger {
      background: #da3633;
    }

    button.danger:hover {
      background: #e5534b;
    }

    .breaker-warning {
      background: #a40e26;
      border: 1px solid #da3633;
      padding: 20px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    .breaker-warning h3 {
      margin-bottom: 10px;
    }

    .refresh-indicator {
      font-size: 12px;
      color: #7d8590;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>ðŸ¦ž OpenClaw Cost Governor</h1>
        <div class="refresh-indicator">Auto-refresh: <span id="countdown">30</span>s</div>
      </div>
      <div id="overall-status" class="status-badge status-safe">Loading...</div>
    </header>

    <div id="breaker-alert" style="display: none;" class="breaker-warning">
      <h3>ðŸ›‘ Circuit Breaker Activated</h3>
      <p id="breaker-reason"></p>
      <button onclick="resetBreaker()" style="margin-top: 10px;">Reset Circuit Breaker</button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-title">Daily Budget</div>
        <div class="budget-item">
          <div class="budget-label">Used / Limit</div>
          <div class="budget-amount" id="daily-amount">-</div>
        </div>
        <div class="budget-bar">
          <div class="budget-bar-fill" id="daily-bar" style="width: 0%;"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Weekly Budget</div>
        <div class="budget-item">
          <div class="budget-label">Used / Limit</div>
          <div class="budget-amount" id="weekly-amount">-</div>
        </div>
        <div class="budget-bar">
          <div class="budget-bar-fill" id="weekly-bar" style="width: 0%;"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Monthly Budget</div>
        <div class="budget-item">
          <div class="budget-label">Used / Limit</div>
          <div class="budget-amount" id="monthly-amount">-</div>
        </div>
        <div class="budget-bar">
          <div class="budget-bar-fill" id="monthly-bar" style="width: 0%;"></div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-title">Providers (Today)</div>
        <div id="providers-list">Loading...</div>
      </div>

      <div class="card">
        <div class="card-title">Top Agents (Today)</div>
        <div id="agents-list">Loading...</div>
      </div>
    </div>
  </div>

  <script>
    let countdownTimer;
    let countdown = 30;

    async function loadStatus() {
      try {
        const response = await fetch('/api/status');
        const data = await response.json();

        // Overall status
        const statuses = [data.budgets.daily.status, data.budgets.weekly.status, data.budgets.monthly.status];
        const worstStatus = statuses.includes('exceeded') ? 'exceeded' :
                           statuses.includes('critical') ? 'critical' :
                           statuses.includes('warning') ? 'warning' : 'safe';

        const statusBadge = document.getElementById('overall-status');
        statusBadge.className = `status-badge status-${worstStatus}`;
        statusBadge.textContent = worstStatus.charAt(0).toUpperCase() + worstStatus.slice(1);

        // Budget cards
        updateBudget('daily', data.budgets.daily);
        updateBudget('weekly', data.budgets.weekly);
        updateBudget('monthly', data.budgets.monthly);

        // Circuit breaker
        const breakerAlert = document.getElementById('breaker-alert');
        if (data.breaker.tripped) {
          breakerAlert.style.display = 'block';
          document.getElementById('breaker-reason').textContent =
            data.breaker.lastEvent ? data.breaker.lastEvent.reason : 'Circuit breaker is tripped';
        } else {
          breakerAlert.style.display = 'none';
        }

        // Providers
        const providersList = document.getElementById('providers-list');
        if (data.summary.providers.length > 0) {
          providersList.innerHTML = data.summary.providers.slice(0, 5).map(p =>
            `<div class="provider-item">
              <span class="provider-name">${p.provider}/${p.model}</span>
              <span class="provider-cost">$${p.total_cost.toFixed(2)}</span>
            </div>`
          ).join('');
        } else {
          providersList.innerHTML = '<div class="provider-item" style="color: #7d8590;">No usage today</div>';
        }

        // Agents
        const agentsList = document.getElementById('agents-list');
        if (data.summary.topAgents.length > 0 && data.summary.topAgents[0].agent_id) {
          agentsList.innerHTML = data.summary.topAgents.slice(0, 5).map(a =>
            `<div class="provider-item">
              <span class="provider-name">${a.agent_id}</span>
              <span class="provider-cost">$${a.total_cost.toFixed(2)}</span>
            </div>`
          ).join('');
        } else {
          agentsList.innerHTML = '<div class="provider-item" style="color: #7d8590;">No agents tracked</div>';
        }

      } catch (error) {
        console.error('Error loading status:', error);
      }
    }

    function updateBudget(period, data) {
      const amount = document.getElementById(`${period}-amount`);
      const bar = document.getElementById(`${period}-bar`);

      amount.textContent = `$${data.used.toFixed(2)} / $${data.limit.toFixed(2)}`;

      bar.style.width = `${Math.min(data.percentUsed, 100)}%`;
      bar.className = `budget-bar-fill fill-${data.status}`;
    }

    async function resetBreaker() {
      try {
        const response = await fetch('/api/reset-breaker', { method: 'POST' });
        const result = await response.json();
        if (result.success) {
          alert('Circuit breaker reset successfully');
          loadStatus();
        } else {
          alert(`Failed to reset: ${result.reason || result.error}`);
        }
      } catch (error) {
        alert('Error resetting breaker: ' + error.message);
      }
    }

    function startCountdown() {
      countdown = 30;
      if (countdownTimer) clearInterval(countdownTimer);

      countdownTimer = setInterval(() => {
        countdown--;
        document.getElementById('countdown').textContent = countdown;

        if (countdown <= 0) {
          loadStatus();
          countdown = 30;
        }
      }, 1000);
    }

    // Initial load
    loadStatus();
    startCountdown();
  </script>
</body>
</html>
